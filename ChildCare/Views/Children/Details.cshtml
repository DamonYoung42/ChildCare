@model ChildCare.Models.Child
<script src="~/Scripts/jquery.min.js" type="text/javascript"></script>
<script src="~/Scripts/moment.min.js" type="text/javascript"></script>
<script src="~/Scripts/fullcalendar.js" type="text/javascript"></script>
<script src="~/Scripts/bootstrap.min.js" type="text/javascript"></script>
<link rel='stylesheet' href='~/Content/fullcalendar.min.css' />
@{
    ViewBag.Title = "Details";
}

@Html.AntiForgeryToken()
@Html.HiddenFor(model => model.Id)
<div>
    <h2>Child Profile</h2>
    <hr />
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.FirstName)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.FirstName)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.LastName)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.LastName)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.GradeLevel)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.GradeLevel)
        </dd>
        <dt>
            @Html.DisplayNameFor(model => model.Teacher)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Teacher.LastName)
        </dd>
        <dt>
            @Html.DisplayNameFor(model => model.Medications)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Medications)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Notes)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Notes)
        </dd>

        <dt>
            @*@Html.DisplayNameFor(model => model.Photo)*@
        </dt>

        <dd>
            <img src="~/Images/Child/@Html.DisplayFor(model => model.Photo)" style="height:100px;width:100px;" />
            @*Html.DisplayFor(model => model.Photo)*@
        </dd>
    </dl>
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span> <span class="sr-only">close</span></button>
                <h4 id="modalTitle" class="modal-title">Pickup</h4>
            </div>
            <div id="deleteModalBody" class="modal-body"></div>
                <input type="hidden" id="deleteModalEventId" />
                <input type="hidden" id="deleteModalCalEventId" />

            <div class="modal-footer">
                <button class="btn btn-danger" onclick="DeleteEvent($('#deleteModalEventId').val(), $('#deleteModalCalEventId').val())">Delete</></button>
                <button type="button" class="btn btn-primary" id="deleteModalClose" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="createModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span> <span class="sr-only">close</span></button>
                <h4 id="createModalTitle" class="modal-title">Pickup</h4>
            </div>
            <div id="createModalBody" class="modal-body"></div>
                <input type="hidden" id="createModalDate" />
                <input type="hidden"  id="createModalChildId" />
                <input type="hidden"  id="createModalPickupTime" />
                <input type="hidden"  id="createModaltitle" />
                <input type="hidden"  id="createModalstart" />
                <input type="hidden"  id="createModalend" />
                <input type="hidden"  id="createModalallDay" />
                <input type="hidden" id="createModaleditable" />
            
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="CreateEvent()">Save</></button>
                <button type="button" class="btn" id="createModalClose" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<p></p>
<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.Id }) |
    @Html.ActionLink("Back to List", "Index")
</p>


<script type="text/javascript">

    $(document).ready(function () {

        // page is now ready, initialize the calendar...

        $('#calendar').fullCalendar({
            // put your options and callbacks here
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            timezone: 'local',
            weekends: true,
            height: 500,
            editable: true,
            cache: true,
            allDay: false,
            displayEventTime: true,
            defaultTimedEventDuration: '00:30:00',
            forceEventDuration: true,
            slotDuration: '00:30:00',
            events: {
                url: '@Url.Action("GetCalendarEvents", "Children")',
                type: 'GET',
                data: {Id: @Model.Id},
                error: function () {
                    alert('There was an error retrieving calendar events!');
                },
            },

            eventClick:  function(event, jsEvent, view) {
                $('#deleteModalTitle').html(event.title);
                $('#deleteModalBody').html(moment(event.start).format('MM-DD-YYYY h:mm A'));
                $('#deleteModalEventId').val(event.Id);
                $('#deleteModalCalEventId').val(event._id);
                $('#deleteModal').modal();
            },

            eventDrop: function (event) {
                EditEvent(event);
            },

            dayClick: function (date, allDay, jsEvent, view) {

                $('#createModalTitle').html("Pickup");
                $('#createModalDate').val(moment(date._d).format('MM-DD-YYYY h:mm A'));
                $('#createModalChildId').val(@Model.Id);
                $('#createModalPickupTime').val(moment(date._d).format('MM-DD-YYYY h:mm A'));
                $('#createModaltitle').val("Pickup");
                $('#createModalstart').val(moment(date._d).format('MM-DD-YYYY h:mm A'));
                $('#createModalend').val(moment(date._d).format('MM-DD-YYYY h:mm A'));
                $('#createModaleditable').val("true");
                $('#createModalallDay').val("false");

                $('#createModal').modal();
            },

            eventConstraint: {
                start: moment().subtract(1, 'week').format('MM-DD-YYYY hh:mm A'),
                end: '2050-05-05'
            },

            eventResize: function (event) {
                if (confirm("Do you want to save this event?")) {
                    //save changes to event in database****
                    EditEvent(event);
                }
            }
        });
    });

    function EditEvent(data) {

        $.ajax({
            //url: '@Url.Action("Edit", "Attendances")'
            url: '../../Attendances/Edit',
            type: "POST",
            dataType: "json",
            data: ({
                __RequestVerificationToken: $('[name= "__RequestVerificationToken"]').val(),
                Date: data.start.format('MM-DD-YYYY hh:mm A'),
                ChildId: @Model.Id,
                PickupTime: data.end.format('MM-DD-YYYY hh:mm A'),
                Id: data.Id,
                title: data.title,
                start: data.start.format('MM-DD-YYYY hh:mm A'),
                end: data.end.format('MM-DD-YYYY hh:mm A'),
                allday: data.allDay,
                editable: data.editable
            }),
            success: function (data, textStatus) {
                if (!data) {
                    alert("Changes could not be saved.");
                    return;
                }
                calendar.fullCalendar('updateEvent', event);
            },
        });
    };

    function DeleteEvent(Id, CalEventId) {
        $.ajax({
            url: '../../Attendances/Delete/' + Id,
            type: "POST",
            dataType: "json",
            data: ({
                __RequestVerificationToken: $('[name= "__RequestVerificationToken"]').val()
            }),

            success: function (data, textStatus) {
                if (!data) {
                    alert("Event could not be deleted.");
                    return;
                }
                
            },
        });
        $('#calendar').fullCalendar('removeEvents', CalEventId);
        $('#deleteModalClose').click();
    };

    function CreateEvent() {

        $.ajax({
            url: '../../Attendances/Create',
            type: "POST",
            dataType: "json",
            data: ({
                __RequestVerificationToken: $('[name= "__RequestVerificationToken"]').val(),
                Date: $('#createModalDate').val(),
                ChildId: $('#createModalChildId').val(),
                PickupTime: $('#createModalPickupTime').val(),
                Id: $('#createModalId').val(),
                title: $('#createModaltitle').val(),
                start: $('#createModalstart').val(),
                end: $('#createModalend').val(),
                allday:$('#createModalallDay').val(),
                editable: $('#createModaleditable').val(),
            }),

            success: function (data, textStatus) {
                if (!data) {
                    alert("Event could not be created.");
                    return;
                }
                $('#calendar').fullCalendar('renderEvent', { title: "Pickup", start: date, end: date }, true);
                calendar.fullCalendar('updateEvent', event);
            },
        });
        //$('#calendar').fullCalendar('renderEvent', { title: "Pickup", start: date, end: date }, true);
        $('#createModalClose').click();
    };
</script>
